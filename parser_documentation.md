# Документация парсера Мой МПТ

## Обзор

Парсер приложения "Мой МПТ" отвечает за извлечение данных о расписании, специальностях, группах и изменениях в расписании с официального сайта Московского приборостроительного техникума (mpt.ru).

## Архитектура парсера

Парсер состоит из нескольких сервисов, каждый из которых отвечает за определенный тип данных. Архитектура следует принципам Clean Architecture и разделена на несколько слоев:

### DataSource слой

#### ScheduleRemoteDataSource
Отвечает за загрузку HTML-страниц с сервера и реализует кэширование для уменьшения количества сетевых запросов.

**Основные функции:**
- Загрузка HTML-страниц с сайта mpt.ru/raspisanie/
- Встроенный кэш с настраиваемым временем жизни
- Обработка таймаутов и ошибок сети

**Методы:**
- `fetchSchedulePage({bool forceRefresh = false})` - Загрузка HTML-страницы с расписанием
- `clearCache()` - Очистка кэша

#### ScheduleCacheDataSource
Отвечает за сохранение и загрузку кэшированного расписания в локальное хранилище устройства.

**Основные функции:**
- Сериализация и десериализация данных расписания
- Хранение расписания на неделю, сегодня и завтра
- Хранение метаинформации о времени последнего обновления

**Методы:**
- `save(ScheduleCache cache)` - Сохранение кэша в локальное хранилище
- `load()` - Загрузка кэша из локального хранилища
- `clear()` - Очистка кэша из локального хранилища

### Parser слой

#### ScheduleHtmlParser
Отвечает за парсинг HTML-документов и извлечение структурированных данных расписания.

**Основные функции:**
- Парсинг HTML-страницы с расписанием
- Извлечение расписания для конкретной группы
- Обработка пар с числителем/знаменателем
- Извлечение информации о времени и корпусе

**Методы:**
- `parse(String html, String groupCode)` - Парсинг HTML-страницы и извлечение расписания

### Service слой

#### ScheduleParserService
Координирует работу DataSource и Parser, предоставляет унифицированный интерфейс для получения расписания.

**Основные функции:**
- Координация работы удаленного источника данных и парсера
- Предоставление унифицированного интерфейса для получения расписания

**Методы:**
- `parseScheduleForGroup(String groupCode, {bool forceRefresh = false})` - Получение расписания для группы
- `clearCache()` - Очистка кэша

#### MptParserService
Отвечает за парсинг данных о специальностях и группах.

**Основные функции:**
- Извлечение списка специальностей
- Получение групп по специальности
- Парсинг информации о неделе (числитель/знаменатель)

**Методы:**
- `parseTabList()` - Получение списка вкладок специальностей
- `parseWeekInfo()` - Получение информации о типе недели
- `parseGroups([String? specialtyFilter])` - Получение списка групп

#### ScheduleChangesService
Отвечает за парсинг изменений в расписании.

**Основные функции:**
- Извлечение изменений с сайта mpt.ru/izmeneniya-v-raspisanii/
- Фильтрация изменений по дате (сегодня/завтра)
- Сопоставление изменений с конкретной группой

**Методы:**
- `parseScheduleChangesForGroup(String groupCode)` - Получение изменений для группы

#### WeekParserService
Отвечает за парсинг информации о текущей неделе.

**Основные функции:**
- Определение типа недели (числитель/знаменатель)
- Получение текущей даты и дня недели

**Методы:**
- `parseWeekInfo()` - Получение информации о неделе

## Поток данных

1. **Инициализация**: Приложение определяет выбранную группу пользователя
2. **Запрос данных**: ScheduleParserService запрашивает HTML-страницу через ScheduleRemoteDataSource
3. **Кэширование**: ScheduleRemoteDataSource проверяет наличие действительного кэша и при необходимости загружает свежую версию
4. **Парсинг**: ScheduleHtmlParser парсит HTML-документ и извлекает структурированные данные
5. **Преобразование**: Извлеченные данные преобразуются в модели приложения
6. **Сохранение кэша**: ScheduleCacheDataSource сохраняет данные в локальное хранилище

## Модели данных

### Lesson
Представляет отдельный урок в расписании:
- `number` - Номер пары
- `subject` - Название предмета
- `teacher` - Преподаватель
- `startTime` - Время начала
- `endTime` - Время окончания
- `building` - Корпус
- `lessonType` - Тип пары (числитель/знаменатель)

### ScheduleChange
Представляет изменение в расписании:
- `lessonNumber` - Номер пары
- `replaceFrom` - Исходный предмет
- `replaceTo` - Новый предмет
- `updatedAt` - Время обновления
- `changeDate` - Дата применения изменений

### Specialty и Group
Представляют специальности и группы:
- `code` - Код специальности/группы
- `name` - Название специальности (для Specialty)

### ScheduleCache
Представляет кэш расписания:
- `weeklySchedule` - Расписание на неделю
- `todaySchedule` - Расписание на сегодня
- `tomorrowSchedule` - Расписание на завтра
- `lastUpdate` - Время последнего обновления

## Обработка ошибок

Все сервисы включают обработку ошибок:
- Таймауты запросов
- Ошибки парсинга
- Недоступность сайта
- Некорректные данные

При возникновении ошибок возвращаются пустые данные или значения по умолчанию.

## Кэширование

Реализовано двухуровневое кэширование:

1. **Временное кэширование в памяти** (ScheduleRemoteDataSource):
   - Кэш обновляется каждые 5 минут
   - Принудительное обновление при необходимости

2. **Постоянное кэширование в локальном хранилище** (ScheduleCacheDataSource):
   - Хранение расписания между сессиями приложения
   - Загрузка кэшированных данных при запуске приложения

## Используемые библиотеки

- `http` - для HTTP-запросов
- `html` - для парсинга HTML-документов
- `shared_preferences` - для хранения настроек пользователя и кэша

## Особенности реализации

1. **Работа с числителем/знаменателем**: Парсер определяет тип недели и корректно отображает пары в зависимости от нее
2. **Поиск групп**: Реализована гибкая система поиска групп по коду специальности
3. **Фильтрация изменений**: Изменения фильтруются по дате и группе для показа только релевантной информации
4. **Модульная архитектура**: Код разделен на независимые модули для лучшей тестируемости и поддержки