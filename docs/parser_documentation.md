# Документация модуля парсера и системы кэширования

## Обзор

Модуль парсера в приложении MyMPT отвечает за извлечение информации о расписании с официального сайта Московского Приборостроительного Техникума (mpt.ru) и преобразование её в структурированные данные для использования в мобильном приложении. Система кэширования обеспечивает эффективное хранение и доступ к данным без постоянных сетевых запросов, что позволяет уменьшить нагрузку на сервер и повысить отзывчивость приложения.

## Архитектура парсера

### Основные компоненты

#### 1. Парсеры данных
- **GroupScheduleParser** (`lib/data/parsers/group_schedule_parser.dart`): Основной парсер, который преобразует HTML-страницу с расписанием в структурированные данные
- **ScheduleDayParser** (`lib/data/parsers/schedule_day_parser.dart`): Парсер для извлечения расписания по дням недели из HTML-таблиц
- **LessonParser** (`lib/data/parsers/lesson_parser.dart`): Парсер для извлечения информации об уроках из HTML-строк таблицы
- **TabListParser** (`lib/data/parsers/tab_list_parser.dart`): Парсер для извлечения списка вкладок специальностей
- **GroupParser** (`lib/data/parsers/group_parser.dart`): Парсер для извлечения информации о группах
- **ReplacementParser** (`lib/data/parsers/replacement_parser.dart`): Парсер для извлечения замен в расписании

#### 2. Источники данных
- **ScheduleRemoteDataSource** (`lib/data/datasources/schedule_remote_data_source.dart`): Загружает свежие данные с сайта техникума
- **ScheduleCacheDataSource** (`lib/data/datasources/schedule_cache_data_source.dart`): Управляет локальным кэшем расписания

#### 3. Координаторы парсинга
- **ScheduleParserRemoteDatasource** (`lib/data/datasources/remote/schedule_parser_remote_datasource.dart`): Координирует процесс парсинга
- **UnifiedScheduleRepository** (`lib/data/repositories/unified_schedule_repository.dart`): Единая точка доступа к данным расписания

## Система кэширования

### Механизм кэширования

Система кэширования в MyMPT использует двухуровневый подход:

1. **Кэш на уровне HTTP-запросов** в ScheduleRemoteDataSource:
   - Время жизни: 24 часа
   - Хранит сырую HTML-страницу
   - Уменьшает количество сетевых запросов

2. **Кэш на уровне приложения** в ScheduleCacheDataSource:
   - Использует SharedPreferences для постоянного хранения
   - Хранит структурированные данные расписания
   - Сохраняет расписание на неделю, сегодня и завтра

### Структура кэша

Кэш представлен моделью ScheduleCache, которая содержит:
- `weeklySchedule`: Расписание на неделю (Map<String, List<Schedule>>)
- `todaySchedule`: Расписание на сегодня (List<Schedule>)
- `tomorrowSchedule`: Расписание на завтра (List<Schedule>)
- `lastUpdate`: Время последнего обновления (DateTime)

### Алгоритм работы с кэшем

1. При запуске приложение пытается восстановить данные из кэша
2. Если кэш отсутствует или устарел (более 24 часов), запускается процесс обновления
3. При обновлении данные загружаются с сайта, парсятся и сохраняются в кэш
4. При ошибке загрузки или парсинга кэш очищается

## Модели данных

### Lesson (`lib/data/models/lesson.dart`)
Представляет отдельный урок в расписании:
- `number`: Номер пары
- `subject`: Название предмета
- `teacher`: Преподаватель
- `startTime`: Время начала
- `endTime`: Время окончания
- `building`: Корпус
- `lessonType`: Тип пары (числитель/знаменатель/null)

### Schedule (`lib/domain/entities/schedule.dart`)
Доменная сущность, используемая в UI слое:
- `id`: Уникальный идентификатор
- Остальные поля аналогичны Lesson

## Процесс парсинга

### Этапы парсинга

1. **Загрузка HTML-страницы**
   - Проверка кэша в ScheduleRemoteDataSource
   - При необходимости загрузка с сайта mpt.ru

2. **Поиск вкладки группы**
   - Поиск вкладки, соответствующей выбранной группе
   - Использование строгих CSS-селекторов для точного совпадения

3. **Извлечение таблиц расписания**
   - Поиск таблиц с классом "table"
   - Извлечение заголовков с днями недели

4. **Парсинг строк таблиц**
   - Извлечение номера пары и времени
   - Обработка обычных пар и пар с числителем/знаменателем
   - Извлечение информации о предметах и преподавателях

5. **Преобразование в доменные сущности**
   - Преобразование Lesson в Schedule
   - Присвоение уникальных идентификаторов

## Интеграция с другими компонентами

### Использование в репозиториях
UnifiedScheduleRepository выступает в роли фасада для доступа к данным:
- Объединяет удаленный и локальный источники данных
- Управляет кэшированием на уровне приложения
- Предоставляет унифицированный интерфейс для получения расписания

### Использование в UI
UI-компоненты используют данные через:
- `getWeeklySchedule()`: Получение недельного расписания
- `getTodaySchedule()`: Получение сегодняшнего расписания
- `getTomorrowSchedule()`: Получение завтрашнего расписания

## Обработка ошибок

Система включает надежную обработку ошибок на всех уровнях:

1. **Сетевые ошибки**
   - Таймауты (15 секунд на запрос)
   - Недоступность сервера
   - Неверные HTTP-статусы

2. **Ошибки парсинга**
   - Некорректная HTML-разметка
   - Отсутствующие элементы
   - Неверный формат данных

3. **Ошибки кэширования**
   - Повреждение данных в SharedPreferences
   - Проблемы с сериализацией/десериализацией

При возникновении ошибок система:
- Очищает кэш
- Возвращает пустые данные вместо выброса исключений
- Логирует ошибки для отладки

## Производительность

### Оптимизации
1. **Кэширование на нескольких уровнях**
2. **Ленивая загрузка данных**
3. **Минимизация сетевых запросов**
4. **Эффективная сериализация данных**

### Время жизни кэша
- HTML-страница: 24 часа
- Структурированные данные: 24 часа
- Принудительное обновление: По запросу пользователя

## Обновление данных

### Автоматическое обновление
- Проверка давности данных при каждом запросе
- Автоматическое обновление при устаревании (более 24 часов)

### Ручное обновление
- Через экран настроек: принудительное обновление HTML-страницы расписания и информации о заменах с отображением времени последнего обновления
- При смене группы: автоматическое обновление расписания и замен с отображением времени последнего обновления
- По запросу пользователя

## Безопасность

### Защита от некорректных данных
- Валидация входных данных
- Обработка граничных случаев
- Устойчивость к изменениям структуры сайта

### Конфиденциальность
- Локальное хранение данных пользователя
- Отсутствие передачи персональных данных на сторонние серверы

## Подробное описание работы компонентов

### GroupScheduleParser

Класс GroupScheduleParser является основным компонентом, отвечающим за преобразование HTML-кода страницы расписания в структурированные данные. Он использует библиотеку `html` для парсинга HTML-документа и делегирует работу вспомогательным парсерам.

#### Основные методы:
1. `parse()` - основной метод, который принимает HTML-страницу и код группы, и возвращает расписание в виде Map<String, List<Lesson>>
2. `_findTabPaneForGroup()` - находит вкладку для указанной группы в HTML-документе

### ScheduleDayParser

Класс ScheduleDayParser отвечает за извлечение расписания по дням недели из HTML-таблиц.

#### Основные методы:
1. `extractDay()` - извлекает день недели из заголовка таблицы
2. `parseLessons()` - парсит уроки из таблицы

### LessonParser

Класс LessonParser отвечает за извлечение информации об уроках из HTML-строк таблицы.

#### Основные методы:
1. `parseLessonRow()` - парсит строку с уроком, обрабатывая как обычные уроки, так и уроки с числителем/знаменателем

### ScheduleRemoteDataSource

Класс ScheduleRemoteDataSource отвечает за загрузку HTML-страницы с расписанием с сервера. Он реализует простое кэширование на уровне HTTP-запросов с временем жизни 24 часа.

#### Основные методы:
1. `fetchSchedulePage()` - загружает HTML-страницу с расписанием, используя кэш при необходимости
2. `_loadFromNetwork()` - выполняет HTTP-запрос к серверу
3. `clearCache()` - очищает кэш

### ScheduleCacheDataSource

Класс ScheduleCacheDataSource управляет кэшированием структурированных данных расписания в локальном хранилище устройства с помощью SharedPreferences.

#### Основные методы:
1. `save()` - сохраняет кэш расписания в локальное хранилище
2. `load()` - загружает кэш расписания из локального хранилище
3. `clear()` - очищает кэш расписания из локального хранилище

### UnifiedScheduleRepository

Класс UnifiedScheduleRepository является центральным компонентом системы, объединяющим все остальные компоненты. Он реализует бизнес-логику работы с расписанием, включая кэширование, обновление данных и предоставление унифицированного интерфейса для доступа к данным.

#### Основные методы:
1. `getWeeklySchedule()` - получает расписание на неделю
2. `getTodaySchedule()` - получает расписание на сегодня
3. `getTomorrowSchedule()` - получает расписание на завтра
4. `refreshAllData()` - обновляет все данные
5. `forceRefresh()` - принудительно обновляет все данные и уведомляет слушателей

### Экран настроек

Экран настроек предоставляет пользователю возможность:
- Выбрать специальность и группу
- Принудительно обновить расписание и информацию о заменах
- Просмотреть время последнего обновления данных

При нажатии на кнопку "Обновить расписание" происходит:
1. Принудительная загрузка HTML-страницы с расписанием с сайта техникума
2. Парсинг новых данных расписания
3. Принудительное обновление информации о заменах через ScheduleChangesService
4. Обновление списка специальностей и групп
5. Сохранение времени обновления в локальное хранилище

Аналогично, при выборе группы также происходит принудительное обновление расписания и замен.

## Жизненный цикл данных

1. При запуске приложения UnifiedScheduleRepository пытается восстановить данные из локального кэша
2. При запросе данных UI-компонентами проверяется актуальность кэша (не старше 24 часов)
3. Если кэш устарел или отсутствует, запускается процесс обновления:
   - ScheduleParserService запрашивает HTML-страницу у ScheduleRemoteDataSource
   - ScheduleRemoteDataSource проверяет свой кэш и при необходимости загружает страницу с сервера
   - ScheduleParserService передает HTML-страницу GroupScheduleParser для парсинга
   - GroupScheduleParser возвращает структурированные данные
   - UnifiedScheduleRepository преобразует данные в доменные сущности и сохраняет их в локальный кэш через ScheduleCacheDataSource
4. UI-компоненты получают актуальные данные через методы UnifiedScheduleRepository

## Особенности реализации

### Обработка числителя/знаменателя
Система корректно обрабатывает пары, которые проводятся по числителю или знаменателю. Для этого используется анализ CSS-классов элементов на странице:
- `.label-danger` соответствует числителю
- `.label-info` соответствует знаменателю

### Поиск группы
Система использует строгие CSS-селекторы для поиска вкладки группы:
1. Сначала пытается найти точное совпадение кода группы
2. Если точное совпадение не найдено, ищет частичное совпадение

### Локализация дней недели
Дни недели хранятся на русском языке ЗАГЛАВНЫМИ буквами, что соответствует формату на сайте техникума.

## Настройки кэширования

Все параметры кэширования можно настроить:
- Время жизни HTTP-кэша: 24 часа (настраивается в ScheduleRemoteDataSource
- Время жизни приложения кэша: 24 часа (настраивается в UnifiedScheduleRepository
- Таймаут HTTP-запросов: 15 секунд (настраивается в ScheduleRemoteDataSource

## Возможные проблемы и решения

1. **Нестабильное соединение**: Система использует таймауты и возвращает кэшированные данные при сетевых ошибках
2. **Изменения структуры сайта**: Использование строгих CSS-селекторов минимизирует влияние незначительных изменений
3. **Повреждение кэша**: Система автоматически очищает поврежденный кэш и загружает новые данные

## Система замен в расписании

### Обзор системы замен
Приложение поддерживает отображение изменений в расписании (замены, отмены занятий, дополнительные занятия) через отдельную систему, которая парсит страницу с изменениями на сайте техникума.

### Основные компоненты системы замен

#### 1. ReplacementRemoteDatasource (`lib/data/datasources/remote/replacement_remote_datasource.dart`)
Сервис, отвечающий за парсинг изменений в расписании с сайта mpt.ru/izmeneniya-v-raspisanii/. Основные функции:
- Загрузка HTML-страницы с изменениями в расписании
- Парсинг изменений для конкретной группы
- Кэширование данных об изменениях
- Принудительное обновление данных при необходимости (forceRefresh)

#### 2. Модели данных замен
- **ReplacementModel** (`lib/data/models/replacement_model.dart`): Модель замены в расписании
- **Replacement** (`lib/domain/entities/replacement.dart`): Доменная сущность замены в расписании

#### 3. Репозитории и Use Cases
- **ReplacementRepository** (`lib/data/repositories/replacement_repository.dart`): Реализация репозитория для работы с заменами в расписании
- **ReplacementRepositoryInterface** (`lib/domain/repositories/replacement_repository_interface.dart`): Интерфейс репозитория замен
- **GetScheduleChangesUseCase** (`lib/domain/usecases/get_schedule_changes_usecase.dart`): Use case для получения замен в расписании

#### 4. Виджеты отображения замен
- **ReplacementCard** (`lib/presentation/widgets/overview/replacement_card.dart`): Виджет карточки замены в расписании

### Механизм работы системы замен

1. **Загрузка данных**
   - ScheduleChangesService загружает HTML-страницу с изменениями в расписании
   - Используется кэширование с временем жизни 5 часов
   - Кэш обновляется в определенные интервалы: 6:00, 11:00, 16:00, 21:00, 00:00
   - Поддерживается принудительное обновление данных без использования кэша через параметр forceRefresh

2. **Парсинг изменений**
   - Парсинг осуществляется для конкретной группы пользователя
   - Извлекаются данные о номере пары, исходном предмете и новом предмете
   - Определяется дата применения изменений

3. **Кэширование**
   - Изменения кэшируются в SharedPreferences
   - Кэш привязан к конкретной группе (hash коду группы)
   - Автоматическое обновление кэша по расписанию

4. **Отображение в UI**
   - Изменения отображаются на экранах расписания
   - Визуальное различие между обычными парами и заменами
   - Отображение зачеркнутых оригинальных предметов при наличии

### Типы изменений в расписании

1. **Замены предметов**: Один предмет заменяется на другой
2. **Отмена занятий**: Занятие отменяется (помечается как "занятие отменено")
3. **Дополнительные занятия**: Добавляются новые занятия
4. **Переносы занятий**: Занятия переносятся на другие даты

### Обработка специальных случаев

1. **Обработка неразрывных пробелов**: Система корректно обрабатывает неразрывные пробелы в данных
2. **Определение корпуса**: Система может определять корпус проведения занятия из текста замены
3. **Фильтрация по дате**: Изменения фильтруются по дате применения (сегодня/завтра)
4. **Скрытие отмененных занятий**: Занятия, помеченные как отмененные, автоматически скрываются из расписания